>  本文主要论述如果优化大文件的网络传输,主要围绕上传流程处理

## 背景说明

文件上传基本是每个系统都需要使用到的接口服务,而当文件比较大时,一来是传输速度会很慢可能会导致响应超时,二来是一整个文件进入服务器内存中,可能会导致系统内存不够用

### 传统文件上传

以简单的普通文件上传进行说明

<uml>

TODO 缺少普通上传流程图

</uml>

* 说明:这种传统的上传方式,在将文件一次性传输至服务器,控制层会将文件默认缓存在本地临时文件中,等待后端进行下一步处理,或者网络卡顿导致传输了一半突然就中断了
* 缺点:这里面的一个前提是文件默认是能够成功一次性传输至后端,如果整个过程任何地方出现异常,流程就中断了.如若文件较大时,可能会因为响应时问过长而导致处理超时,
* 安全方面:可能会因为多个用户同时请求攻击一个文件上传点,导致服务器网络被限制至少后端无法对该用户请求进行判断限流操作)另外就是大文件处理往往需要非常长的时问。可能服务器线程会处理不过来

#### 改善方式:

1. 上传验证:即限制最大上传文件大小,超过默认不进行处理
2. 钞能力:扩大服务器带宽
3. 优化改进:优化为分片上传(查看下文详情分析)

## 分片上传

* 上述传统的文件上传可以看到，其内在核心问题就是文件太大，当带宽处理不过来时，响应超时后导致得重新上传，如若把文件进行切片处理，并一片片传输至后端，由后端进行组装最后生成最终文件即可比较有效的减少这种情况

* 可以看到相较于传统上传则是多了步前端的文件切片以及 后端的组装文件
* 但是流程中有两个题:
  * 如何确定上下文请求的文件一致性
    * 即当用户上传一半时，重新上传其他文件，后端需确认两次上传不是同一个文件
  * 如何处理临时文件
    * 及如若中途中断上传，那么临时文件改如何处理

### 文件id-部分数据md5

* 文件md5是文件一 致性校验最简单以及最好的方式

* 但是通常来说上传文件都比较大，计算一 次1GB的文件md5可能需要都需要半分钟
* 个人比较推荐前端提取文件前n个byte与文件名，当前时间相加数据进行md5提取



### 临时文件处理

* 说明:用户上传过程中所-片片传输过来的文件都是临时文件
* 背景:前端分片传输给后端过程中，如若用户刷新页面，则上传中断，且后端无法得知用户主动中断请求，如何处理中断后的文件
* 建议处理方式:
  1. 简单粗暴:定时扫描临时文件夹，对于创建时间大于一小时的文件进行删除
  2. 服务于断点上传:此次上传可能是用户不小心取消，后端可以记录上传文件位置，等待下一-次上传该文件
     以上即分片上传的基本方法:基本可以满足大部分系统后面部分都是对上述方法进行优化处理

> 以上即分片上传的基本方法:基本可以满足大部分系统后面部分都是对上述方法进行优化处理



### 优化处理

#### 多线程分片上传

* 上述基本的分片上传有效率问题:

* 全程单线程:等待网络传输完成 -> 等待后端IO处理 -> 等待前端IO处理 -> 等待网络传输完成
